name: Ping My Movie Sites
on:
  schedule:
    # æ¯ 50 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼ˆå»ºè®®æ”¹ä¸º 30 åˆ†é’Ÿæ›´ç¨³å¦¥ï¼Œé˜²æ­¢éƒ¨åˆ†å¹³å° 1 å°æ—¶å›æ”¶èµ„æºï¼‰
    - cron: '*/50 * * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Check Sites Availability
        run: |
          # å®šä¹‰ç›‘æ§å‡½æ•°
          check_site() {
            local url=$1
            local name=$2
            local max_retries=3
            local count=0
            local success=false

            echo "ğŸ” æ­£åœ¨æ£€æŸ¥: $name ($url) ..."

            while [ $count -lt $max_retries ]; do
              count=$((count + 1))
              
              # ä½¿ç”¨ curl è·å–å“åº”ï¼ŒåŒæ—¶æ•è·çŠ¶æ€ç å’Œå†…å®¹å¿«ç…§
              # --compressed å¤„ç† gzip/br å‹ç¼©
              # -L è·Ÿéšé‡å®šå‘
              response=$(curl -L -s -w "%{http_code}" \
                -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
                -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" \
                -H "Accept-Language: zh-CN,zh;q=0.9,en;q=0.8" \
                --compressed \
                --connect-timeout 20 \
                --max-time 40 \
                "$url")

              # æå–çŠ¶æ€ç ï¼ˆæœ€åä¸‰ä½ï¼‰
              status_code="${response: -3}"
              # æå–ç½‘é¡µå†…å®¹å‰ç¼€ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦è¢«æ‹¦æˆªæˆ–ä¸ºç©ºï¼‰
              content_preview="${response:0:100}"

              if [[ $status_code =~ ^[23][0-9]{2}$ ]]; then
                echo "âœ… $name è®¿é—®æˆåŠŸ | çŠ¶æ€ç : $status_code"
                success=true
                break
              else
                echo "âš ï¸ $name ç¬¬ $count æ¬¡å°è¯•å¤±è´¥ | çŠ¶æ€ç : $status_code | é‡è¯•ä¸­..."
                sleep 5
              fi
            done

            if [ "$success" = false ]; then
              echo "âŒ $name è¿ç»­ $max_retries æ¬¡è®¿é—®å¤±è´¥ï¼"
              return 1
            fi
          }

          # --- é…ç½®åŒºï¼šåœ¨æ­¤æ·»åŠ æˆ–ä¿®æ”¹ä½ çš„ç½‘å€ ---
          # æ ¼å¼: check_site "ç½‘å€" "å¤‡æ³¨åç§°"
          
          # è®°å½•å¤±è´¥æ¬¡æ•°
          failed_count=0
          
          check_site "https://bad.zeabur.app" "Zeaburå½±è§†ç«™" || failed_count=$((failed_count + 1))
          check_site "https://mozila.eu.org" "Cloudflare Pageså½±è§†ç«™" || failed_count=$((failed_count + 1))

          # å¦‚æœæœ‰ä»»ä½•ä¸€ä¸ªç«™ç‚¹å¤±è´¥ï¼Œåˆ™ä»¥é”™è¯¯çŠ¶æ€é€€å‡ºï¼Œè§¦å‘ GitHub é‚®ä»¶æé†’
          if [ $failed_count -gt 0 ]; then
            echo "ğŸš¨ æ£€æµ‹åˆ° $failed_count ä¸ªç«™ç‚¹è®¿é—®å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ï¼"
            exit 1
          fi

        timeout-minutes: 10
